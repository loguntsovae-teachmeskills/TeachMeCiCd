# Workflow –¥–ª—è Continuous Deployment
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤

name: CD - Continuous Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
  test:
    name: –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
        run: |
          pytest -v --cov=. --cov-report=term --cov-report=html
      
      - name: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 30

  # –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è Docker –æ–±—Ä–∞–∑–∞
  build-and-push:
    name: –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è –æ–±—Ä–∞–∑–∞
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: –í—Ö–æ–¥ –≤ Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –¥–ª—è Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: –°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è Docker –æ–±—Ä–∞–∑–∞
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # –î–µ–ø–ª–æ–π –≤ staging –æ–∫—Ä—É–∂–µ–Ω–∏–µ
  deploy-staging:
    name: –î–µ–ø–ª–æ–π –≤ Staging
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: staging
      url: https://staging.example.com
    
    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4
      
      - name: –°–∏–º—É–ª—è—Ü–∏—è –¥–µ–ø–ª–æ—è –≤ staging
        run: |
          echo "üöÄ –î–µ–ø–ª–æ–π –≤ staging –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
          echo "–û–±—Ä–∞–∑: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main"
          echo "–ö–æ–º–º–∏—Ç: ${{ github.sha }}"
          
          # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∑–¥–µ—Å—å –±—É–¥–µ—Ç:
          # - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ staging —Å–µ—Ä–≤–µ—Ä—É
          # - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ docker-compose –∏–ª–∏ Kubernetes –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤
          # - –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
          # - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –≤ staging –∑–∞–≤–µ—Ä—à–µ–Ω"
      
      - name: Smoke —Ç–µ—Å—Ç—ã –Ω–∞ staging
        run: |
          echo "üß™ –ó–∞–ø—É—Å–∫ smoke —Ç–µ—Å—Ç–æ–≤ –Ω–∞ staging..."
          # curl -f https://staging.example.com/health
          echo "‚úÖ Smoke —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã"

  # –î–µ–ø–ª–æ–π –≤ production (—Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –æ–¥–æ–±—Ä–µ–Ω–∏—è)
  deploy-production:
    name: –î–µ–ø–ª–æ–π –≤ Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment:
      name: production
      url: https://api.example.com
    
    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4
      
      - name: –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞
        run: |
          echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ production..."
          echo "Timestamp: $(date +%Y%m%d-%H%M%S)"
          echo "‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω"
      
      - name: –î–µ–ø–ª–æ–π –≤ production
        run: |
          echo "üöÄ –î–µ–ø–ª–æ–π –≤ production –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
          echo "–û–±—Ä–∞–∑: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          
          # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ:
          # - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ production —Å–µ—Ä–≤–µ—Ä—É
          # - Blue-green deployment –∏–ª–∏ rolling update
          # - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
          # - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π —Å –æ—Ç–∫–∞—Ç–æ–º –ø—Ä–∏ –æ—à–∏–±–∫–µ
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –≤ production –∑–∞–≤–µ—Ä—à–µ–Ω"
      
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ production..."
          # curl -f https://api.example.com/health
          echo "‚úÖ Production —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
      
      - name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
        run: |
          echo "üìß –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥–µ..."
          echo "–í–µ—Ä—Å–∏—è ${{ github.sha }} —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞ –≤ production"

  # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
  post-deploy:
    name: –ü–æ—Å—Ç-–¥–µ–ø–ª–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
    runs-on: ubuntu-latest
    needs: deploy-production
    
    steps:
      - name: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫
        run: |
          echo "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          sleep 5
          echo "  - CPU: OK"
          echo "  - Memory: OK"
          echo "  - Response Time: OK"
          echo "  - Error Rate: OK"
          echo "‚úÖ –í—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –≤ –Ω–æ—Ä–º–µ"
      
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
        run: |
          echo "üìù –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤..."
          echo "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ"
          echo "‚úÖ –õ–æ–≥–∏ —á–∏—Å—Ç—ã–µ"

  # –û—Ç–∫–∞—Ç –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
  rollback:
    name: –û—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: failure()
    
    steps:
      - name: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–∫–∞—Ç
        run: |
          echo "‚ùå –û–ë–ù–ê–†–£–ñ–ï–ù–ê –ü–†–û–ë–õ–ï–ú–ê - –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–∞—Ç–∞..."
          echo "‚è™ –û—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏..."
          sleep 2
          echo "‚úÖ –û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ"
          echo "üìß –ö–æ–º–∞–Ω–¥–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∞ –æ –ø—Ä–æ–±–ª–µ–º–µ"
