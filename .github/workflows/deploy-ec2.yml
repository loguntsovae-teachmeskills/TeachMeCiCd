# Workflow –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è –Ω–∞ AWS EC2
# –î–µ–ø–ª–æ–π –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –º–µ—Ä–¥–∂–µ –∏–∑ develop –≤ main

name: Deploy to AWS EC2

on:
  push:
    branches:
      - main  # –î–µ–ø–ª–æ–π —Ç–æ–ª—å–∫–æ –ø—Ä–∏ push –≤ main (–æ–±—ã—á–Ω–æ –ø–æ—Å–ª–µ merge –∏–∑ develop)
  workflow_dispatch:  # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é

env:
  APP_NAME: teachme-cicd-api
  DEPLOY_PATH: /home/ubuntu/app
  
jobs:
  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —ç—Ç–æ merge –∏–∑ develop –≤ main
  check-source:
    name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    
    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ merge
        id: check
        run: |
          # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–º–º–∏—Ç–∞
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ merge –∫–æ–º–º–∏—Ç–æ–º –∏–∑ develop
          if [[ "$COMMIT_MSG" == *"Merge"*"develop"* ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "‚úÖ –î–µ–ø–ª–æ–π —Ä–∞–∑—Ä–µ—à–µ–Ω - —ç—Ç–æ merge –∏–∑ develop –∏–ª–∏ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è –î–µ–ø–ª–æ–π –ø—Ä–æ–ø—É—â–µ–Ω - —ç—Ç–æ –Ω–µ merge –∏–∑ develop"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
  test:
    name: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
    runs-on: ubuntu-latest
    needs: check-source
    if: needs.check-source.outputs.should_deploy == 'true'
    
    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          pip install -r requirements.txt
      
      - name: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
        run: |
          pytest -v --tb=short
      
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤
        run: |
          python -c "from main import app; print('‚úÖ –ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–µ–Ω')"

  # –î–µ–ø–ª–æ–π –Ω–∞ AWS EC2
  deploy:
    name: –î–µ–ø–ª–æ–π –Ω–∞ AWS EC2
    runs-on: ubuntu-latest
    needs: [check-source, test]
    if: needs.check-source.outputs.should_deploy == 'true'
    environment:
      name: production
    
    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4
      
      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –∫–ª—é—á–∞
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key.pem
          chmod 600 ~/.ssh/deploy_key.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
      
      - name: –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        run: |
          tar -czf app.tar.gz \
            --exclude='venv' \
            --exclude='__pycache__' \
            --exclude='.pytest_cache' \
            --exclude='.git' \
            --exclude='*.pyc' \
            --exclude='htmlcov' \
            --exclude='.coverage' \
            app/ main.py requirements.txt Dockerfile docker-compose.yml
      
      - name: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        run: |
          scp -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no \
            app.tar.gz \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ env.DEPLOY_PATH }}/
      
      - name: –î–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        run: |
          ssh -i ~/.ssh/deploy_key.pem -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
          
          set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
          
          echo "üì¶ –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          cd ${{ env.DEPLOY_PATH }}
          tar -xzf app.tar.gz
          rm app.tar.gz
          
          echo "üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          
          echo "üìù –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–µ–ø–ª–æ–µ..."
          cat > /tmp/deployment_info.json << EOF
          {
            "deployed_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit_sha": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "deployed_by": "${{ github.actor }}",
            "workflow_run": "${{ github.run_number }}"
          }
          EOF
          
          echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –ø—Ä–æ—Ü–µ—Å—Å
          pkill -f "python.*main.py" || true
          sleep 2
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å
          nohup venv/bin/python main.py > app.log 2>&1 &
          
          echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          sleep 5
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
          ENDSSH
      
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ health endpoint..."
          sleep 3
          
          HEALTH_CHECK=$(curl -s -o /dev/null -w "%{http_code}" \
            http://${{ secrets.EC2_HOST }}:8003/health || echo "000")
          
          if [ "$HEALTH_CHECK" = "200" ]; then
            echo "‚úÖ Health check —É—Å–ø–µ—à–µ–Ω - –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
          else
            echo "‚ùå Health check –ø—Ä–æ–≤–∞–ª–µ–Ω (HTTP $HEALTH_CHECK)"
            exit 1
          fi
          
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ deployment endpoint..."
          DEPLOY_INFO=$(curl -s http://${{ secrets.EC2_HOST }}:8003/deployment || echo "{}")
          echo "Deployment info: $DEPLOY_INFO"
      
      - name: –û—á–∏—Å—Ç–∫–∞ SSH –∫–ª—é—á–∞
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key.pem

  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
  notify:
    name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–µ–ø–ª–æ–µ
    runs-on: ubuntu-latest
    needs: [check-source, test, deploy]
    if: always() && needs.check-source.outputs.should_deploy == 'true'
    
    steps:
      - name: –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–µ–ø–ª–æ—è
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "üéâ –î–µ–ø–ª–æ–π –Ω–∞ AWS EC2 –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
            echo "‚úÖ –ö–æ–º–º–∏—Ç: ${{ github.sha }}"
            echo "‚úÖ –í–µ—Ç–∫–∞: ${{ github.ref_name }}"
            echo "‚úÖ –ê–≤—Ç–æ—Ä: ${{ github.actor }}"
            echo ""
            echo "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ–ø–ª–æ–π:"
            echo "curl http://${{ secrets.EC2_HOST }}:8003/deployment"
          else
            echo "‚ùå –î–µ–ø–ª–æ–π –ø—Ä–æ–≤–∞–ª–µ–Ω!"
            echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π"
            exit 1
          fi
